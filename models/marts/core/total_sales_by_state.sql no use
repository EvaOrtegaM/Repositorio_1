{% set states = obtener_valores(ref('stg_sql_server_dbo_addresses'),trim(state) as state) %}

WITH stg_addresses AS (
    SELECT * 
    FROM {{ ref('stg_sql_server_dbo_addresses') }}
    ),

stg_orders AS (
    SELECT * 
    FROM {{ ref('stg_sql_server_dbo_orders') }}
    ),    

state_orders AS (
    SELECT
        a.state,
        {%- for state in states  %}
        sum(case when state = '{{state}}' then 1 else 0 end) as {{state}}_number_sales
        {%- if not loop.last %},{% endif -%}
        {% endfor %}
    FROM stg_addresses a
    left join stg_orders o using (address_id)
    GROUP BY a.state
    )
    

SELECT * FROM state_orders