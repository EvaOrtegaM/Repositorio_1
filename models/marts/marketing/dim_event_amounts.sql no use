{% set event_types = obtener_valores(ref('stg_sql_server_dbo_events'),'event_type') %}

WITH stg_events AS (
    SELECT * 
    FROM {{ ref('stg_sql_server_dbo_events') }}
    ),

stg_users AS (
    SELECT * 
    FROM {{ ref('stg_sql_server_dbo_users') }}
    ),    

final AS (
    SELECT
        u.user_id,
        u.first_name,
        u.last_name,        
        {%- for event_type in event_types   %}
        sum(case when event_type = '{{event_type}}' then 1 else 0 end) as {{event_type}}_amount
        {%- if not loop.last %},{% endif -%}
        {% endfor %}

        --count(e.session_id) as number_of_sessions
        --max(e.event_created_at_utc) as most_recent_event_date,        

    FROM stg_events e
    left join  stg_users u using (user_id)

    GROUP BY user_id
    --, e.session_id

    )
    

SELECT * FROM final