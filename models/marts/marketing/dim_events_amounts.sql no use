{% set event_types = obtener_valores(ref('stg_sql_server_dbo_events'),'event_type') %}

WITH stg_events AS (
    SELECT * FROM {{ ref('stg_sql_server_dbo_events') }}
    ),

stg_users as (
    select * from {{ ref('stg_sql_server_dbo_users') }}
), 

user_events as (

    select
        user_id,
        {%- for event_type in event_types   %}
        sum(case when event_type = '{{event_type}}' then 1 else 0 end) as {{event_type}}_amount
        {%- if not loop.last %},{% endif -%}
        {% endfor %}

    from stg_events e
    left join stg_users u using(user_id)

    group by user_id

),    

final as (
    select
        stg_events.user_id
        user_events.page_view_amount,
        user_events.add_to_cart_amount,
        user_events.package_shipped_amount,
        user_events.checkout_amount,
        min(stg_events.event_created_at_utc) as first_session_date,
        max(stg_events.event_created_at_utc) as most_recent_session_date,
        count(stg_events.session_id) as number_of_sessions

    from stg_events e
    join user_events u using(user_id)
    gorup by user_id
),

SELECT * FROM final